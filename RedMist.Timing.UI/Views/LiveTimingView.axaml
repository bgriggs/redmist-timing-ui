<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:design="clr-namespace:RedMist.Timing.UI.ViewModels.Design"
			 xmlns:conv="clr-namespace:RedMist.Timing.UI.Converters"
			 xmlns:sel="clr-namespace:RedMist.Timing.UI.TemplateSelectors"
			 xmlns:c="clr-namespace:RedMist.Timing.UI.Controls"
			 xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
			 xmlns:model="using:RedMist.Timing.UI.ViewModels"
			 mc:Ignorable="d" d:DesignWidth="430" d:DesignHeight="450"
			 x:Class="RedMist.Timing.UI.Views.LiveTimingView"
			 x:DataType="model:LiveTimingViewModel">
	<Design.DataContext>
		<!-- This only sets the DataContext for the previewer in an IDE,
		to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
		<design:DesignLiveTimingViewModel />
	</Design.DataContext>

	<UserControl.Resources>
		<!--Car Row Template-->
		<DataTemplate x:Key="carTemplate" DataType="model:CarViewModel">
			<Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto">
				<!--Row update flash animation-->
				<Grid.Transitions>
					<Transitions>
						<BrushTransition Property="Background" Duration="0:0:1"/>
					</Transitions>
				</Grid.Transitions>
				<Grid.Background>
					<SolidColorBrush Color="{Binding RowBackground}"/>
				</Grid.Background>
				<!--<Border Grid.ColumnSpan="3" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource BorderPrimaryBrush}" VerticalAlignment="Bottom"/>-->

				<!--Car position and positions gained/lost-->
				<Grid RowDefinitions="Auto,*,Auto" HorizontalAlignment="Center">
					<TextBlock Text="{Binding Position}" Classes="lg" Grid.Column="0" Margin="2,0,0,0" Width="30" HorizontalAlignment="Left"/>

					<!--Positions gained/lost-->
					<StackPanel DataContext="{Binding PositionsGainedLost}" Grid.Row="2" HorizontalAlignment="Left" Margin="3,0,0,1">
						<Grid ColumnDefinitions="Auto,Auto" IsVisible="{Binding IsGain}">
							<PathIcon Height="8" Width="8" Foreground="{DynamicResource PositionsGainedForegroundBrush}" Data="{StaticResource upArrow}" VerticalAlignment="Top" Margin="0,1,0,0"/>
							<TextBlock Text="{Binding PositionChangeText}" Classes="sm" Foreground="{DynamicResource PositionsGainedForegroundBrush}" Grid.Column="1"/>
						</Grid>
						<Grid ColumnDefinitions="Auto,Auto" IsVisible="{Binding IsLoss}">
							<PathIcon Height="8" Width="8" Foreground="{DynamicResource PositionsLostForegroundBrush}" Data="{StaticResource downArrow}"/>
							<TextBlock Text="{Binding PositionChangeText}" Classes="sm" Foreground="{DynamicResource PositionsLostForegroundBrush}" Grid.Column="1"/>
						</Grid>
						<Grid ColumnDefinitions="Auto,Auto" IsVisible="{Binding IsNoChange}">
							<StackPanel Orientation="Vertical">
								<PathIcon Height="8" Width="8" Foreground="{DynamicResource PositionsNeutralForegroundBrush}" Data="{StaticResource upArrow}"/>
								<PathIcon Height="8" Width="8" Foreground="{DynamicResource PositionsNeutralForegroundBrush}" Data="{StaticResource downArrow}" Margin="0,-2,0,0"/>
							</StackPanel>
							<TextBlock Text="0" Classes="sm" Foreground="{DynamicResource PositionsNeutralForegroundBrush}" Grid.Column="1" Margin="1,0,0,0" VerticalAlignment="Center"/>
						</Grid>
					</StackPanel>
				</Grid>
				<Grid RowDefinitions="Auto,Auto,Auto" Margin="0,0,0,1" Grid.Column="1">
					<c:AdaptiveCarInfoPanel x:Name="CarInfoPanel"
											ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
											PageSize="{Binding PageSize}"
											NumberIndex="0"
											NameIndex="1"
											ClassIndex="2"
											InClassPosGainedIndex="3"
											OverallPosGainedIndex="4"
											InClassFastestAveragePaceIndex="5"
											InCarVideoIndex="6"
											PitStateIndex="7"
											DriverNameIndex="8"
											IsDriverNameInline="{Binding IsDriverNameInline, Mode=TwoWay}">
						<TextBlock Text="{Binding Number, StringFormat='#{0}'}" Classes="carnum" VerticalAlignment="Center"/>
						<TextBlock Text="{Binding Name}" Grid.Column="1" Margin="2,0,1,0" Classes="lg" TextTrimming="CharacterEllipsis"/>
						<Border Grid.Column="3" Margin="1" CornerRadius="4" Background="{Binding ClassColor}">
							<TextBlock Text="{Binding Class}" Classes="smb"
									   Padding="8,2" VerticalAlignment="Bottom" HorizontalAlignment="Center"/>
						</Border>

						<PathIcon Grid.Column="4" Height="10" Width="10"
								  Foreground="{DynamicResource LightningIconBrush}" Data="{StaticResource lightning}"
								  IsVisible="{Binding IsClassMostPositionsGained}" ToolTip.Tip="Most in-class positions gained"/>
						<PathIcon Grid.Column="5" Height="12" Width="12" Foreground="{DynamicResource LightningIconBrush}" Data="{StaticResource doubleLightning}"
								  IsVisible="{Binding IsOverallMostPositionsGained}" ToolTip.Tip="Most positions gained"/>
						<PathIcon Grid.Column="6" Height="20" Width="20" Foreground="{DynamicResource carRowLapTextForegroundOverallBestBrush}" Data="{StaticResource fastpace}"
								  IsVisible="{Binding InClassFastestAveragePace}" ToolTip.Tip="Fastest pace in-class"/>
						<Button Grid.Column="7" Classes="icon" IsVisible="{Binding IsCarStreaming}" Command="{Binding LaunchInCarVideo}" ToolTip.Tip="Open in-car video" Padding="0" Height="13" Margin="2,0,0,0">
							<Image Source="{Binding CarStreamImage}" Cursor="Hand"/>
						</Button>

						<ContentControl Content="{Binding PitState}" Grid.Column="8">
							<ContentControl.DataTemplates>
								<sel:PitIconTemplateSelector>
									<DataTemplate x:Key="InPitTemplate">
										<Border Width="45" Margin="1" CornerRadius="4" Background="{DynamicResource PitStateInPitBrush}">
											<TextBlock Text="PIT" Classes="pit"/>
										</Border>
									</DataTemplate>
									<DataTemplate x:Key="EnteredPitTemplate">
										<Border Width="68" Margin="1" CornerRadius="4" Background="{DynamicResource PitStateEnteredBrush}">
											<TextBlock Text="ENTERED PIT" Classes="pit"/>
										</Border>
									</DataTemplate>
									<DataTemplate x:Key="ExitedPitTemplate">
										<Border Width="63" Margin="1" CornerRadius="4" Background="{DynamicResource PitStateExitedBrush}">
											<TextBlock Text="EXITED PIT" Classes="pit"/>
										</Border>
									</DataTemplate>
									<DataTemplate x:Key="PitSfTemplate">
										<Border Width="50" Margin="1" CornerRadius="4" Background="{DynamicResource PitStateSfBrush}" ToolTip.Tip="Passed Pit Start / Finish">
											<TextBlock Text="PIT S/F" Classes="pit"/>
										</Border>
									</DataTemplate>
									<DataTemplate x:Key="NoPit">
									</DataTemplate>
								</sel:PitIconTemplateSelector>
							</ContentControl.DataTemplates>
						</ContentControl>
						<TextBlock Text="{Binding DriverName, StringFormat='Driver: {0}'}" Grid.Column="2" Classes="sm" Margin="4,0,1,0" VerticalAlignment="Center" IsVisible="False"/>
					</c:AdaptiveCarInfoPanel>

					<!--Driver Name (shown on its own row only when not displayed inline in the panel above)-->
					<TextBlock Text="{Binding DriverName, StringFormat='Driver: {0}'}" Grid.Row="1"
							   IsVisible="{Binding IsDriverNameStandaloneVisible}"
							   Classes="sm" Margin="0"/>

					<Grid ColumnDefinitions="Auto,Auto,Auto,Auto,*,Auto" Grid.Row="2">
						<StackPanel Orientation="Horizontal" Width="102">
							<TextBlock Text="{Binding LastLap}" Classes="sm" Foreground="{Binding LapDataColor}" FontWeight="{Binding LapDataFontWeight}"/>
							<TextBlock Text=" / " Classes="sm" Foreground="{Binding LapDataColor}" FontWeight="{Binding LapDataFontWeight}"/>
							<TextBlock Text="{Binding LastTimeShort}" Classes="sm" Foreground="{Binding LapDataColor}" FontWeight="{Binding LapDataFontWeight}"/>
						</StackPanel>

						<TextBlock Text="{Binding Gap}" Grid.Column="1" Classes="sm" Width="70"/>
						<TextBlock Text="{Binding Difference}" Grid.Column="2" Classes="sm" Width="70"/>

						<StackPanel Orientation="Horizontal" Grid.Column="3" IsVisible="{Binding ShowPenaltyColumn}">
							<PathIcon Height="10" IsVisible="{Binding HasPenaltyWarnings}" Margin="0,0,0,1" Foreground="{DynamicResource LightningIconBrush}" Data="{StaticResource warningopengeom}" VerticalAlignment="Center" ToolTip.Tip="Car was issued a warning"/>
							<StackPanel Orientation="Horizontal" IsVisible="{Binding HasPenaltyLaps}">
								<TextBlock Text="{Binding PenaltyLaps, StringFormat='-{0}'}" Classes="sm"/>
								<TextBlock Text="{Binding PenaltyLapTerm}" Classes="sm" Margin="2,0,0,0"/>
							</StackPanel>
						</StackPanel>

						<StackPanel Orientation="Horizontal" Grid.Column="5" Margin="0,0,6,0">
							<TextBlock Text="{Binding BestLap}" Classes="sm" Foreground="{Binding BestLapDataColor}" FontWeight="{Binding BestLapDataFontWeight}"/>
							<TextBlock Text=" / " Classes="sm" Foreground="{Binding BestLapDataColor}" FontWeight="{Binding BestLapDataFontWeight}"/>
							<TextBlock Text="{Binding BestTimeShort}" Classes="sm" Foreground="{Binding BestLapDataColor}" FontWeight="{Binding BestLapDataFontWeight}"/>
						</StackPanel>
					</Grid>
				</Grid>

				<!--Lap projection progress bar Row 1-->
				<Grid Grid.Row="1" Grid.ColumnSpan="2" Height="1.2" ClipToBounds="True" Margin="0,1,0,0">
					<!--Track background-->
					<Border Background="{DynamicResource LapProgressTrackBrush}" CornerRadius="0"/>

					<!--Normal progress fill (0 to 1.0)-->
					<Border Background="{DynamicResource LapProgressNormalBrush}" CornerRadius="0"
							HorizontalAlignment="Stretch" RenderTransformOrigin="0%,50%">
						<Border.Transitions>
							<Transitions>
								<TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.6" Easing="CubicEaseOut"/>
							</Transitions>
						</Border.Transitions>
						<Border.RenderTransform>
							<ScaleTransform ScaleX="{Binding LapProgressNormalFraction}"/>
						</Border.RenderTransform>
					</Border>

					<!--Overrun progress fill (past 1.0), positioned after the normal portion-->
					<Border Background="{DynamicResource LapProgressOverrunBrush}" CornerRadius="0"
							HorizontalAlignment="Stretch" RenderTransformOrigin="0%,50%"
							IsVisible="{Binding IsLapProgressOverrun}">
						<Border.Transitions>
							<Transitions>
								<TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.6" Easing="CubicEaseOut"/>
							</Transitions>
						</Border.Transitions>
						<Border.RenderTransform>
							<TransformGroup>
								<ScaleTransform ScaleX="{Binding LapProgressOverrunFraction}"/>
								<TranslateTransform>
									<TranslateTransform.X>
										<MultiBinding Converter="{x:Static conv:LapProgressMarkerPositionConverter.Instance}">
											<Binding Path="LapProgressNormalFraction"/>
											<Binding Path="Bounds.Width" RelativeSource="{RelativeSource AncestorType=Grid}"/>
										</MultiBinding>
									</TranslateTransform.X>
								</TranslateTransform>
							</TransformGroup>
						</Border.RenderTransform>
					</Border>

					<!--Marker at the 1.0 threshold (76.9% of the bar)-->
					<Border Width="1" Height="3" Background="{DynamicResource LapProgressMarkerBrush}"
							HorizontalAlignment="Left" VerticalAlignment="Center">
						<Border.RenderTransform>
							<TranslateTransform>
								<TranslateTransform.X>
									<MultiBinding Converter="{x:Static conv:LapProgressMarkerPositionConverter.Instance}">
										<Binding Source="{x:Static conv:LapProgressMarkerPositionConverter.ThresholdFraction}"/>
										<Binding Path="Bounds.Width" RelativeSource="{RelativeSource AncestorType=Grid}"/>
									</MultiBinding>
								</TranslateTransform.X>
							</TranslateTransform>
						</Border.RenderTransform>
					</Border>
				</Grid>

			</Grid>
		</DataTemplate>

		<!--Car Row Toggle Button-->
		<ControlTemplate x:Key="rowToggleButtonTemplate" TargetType="ToggleButton">
			<Border x:Name="ToggleButtonBackground" CornerRadius="{TemplateBinding CornerRadius}"
					Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}"
					BorderThickness="{TemplateBinding BorderThickness}">
				<Grid x:Name="ToggleButtonGrid" ColumnDefinitions="*,Auto">
					<ContentPresenter x:Name="PART_ContentPresenter" Content="{TemplateBinding Content}"
									  ContentTemplate="{TemplateBinding ContentTemplate}" HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
									  VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" Foreground="{TemplateBinding Foreground}"
									  Margin="{TemplateBinding Padding}"/>
				</Grid>
			</Border>
		</ControlTemplate>

		<!--Car Row Expander-->
		<ControlTemplate x:Key="rowExpanderTemplate" TargetType="Expander">
			<DockPanel MinWidth="{TemplateBinding MinWidth}" MaxWidth="{TemplateBinding MaxWidth}">
				<ToggleButton x:Name="ExpanderHeader" Template="{StaticResource rowToggleButtonTemplate}"
							  CornerRadius="{TemplateBinding CornerRadius}"
							  IsEnabled="{TemplateBinding IsEnabled}" Content="{TemplateBinding Header}"
							  ContentTemplate="{TemplateBinding HeaderTemplate}" IsChecked="{TemplateBinding IsExpanded, Mode=TwoWay}"
							  Background="Transparent" BorderBrush="{DynamicResource BorderPrimaryBrush}" Padding="0"/>
				<Border x:Name="ExpanderContent" IsVisible="{TemplateBinding IsExpanded, Mode=TwoWay}"
						Background="Transparent" BorderBrush="{TemplateBinding BorderBrush}"
						BorderThickness="{TemplateBinding BorderThickness}"	MinHeight="{TemplateBinding MinHeight}"
						HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Padding="{TemplateBinding Padding}">
					<ContentPresenter x:Name="PART_ContentPresenter" Content="{TemplateBinding Content}"
									  ContentTemplate="{TemplateBinding ContentTemplate}" Foreground="{TemplateBinding Foreground}"
									  HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
									  VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
				</Border>
			</DockPanel>
		</ControlTemplate>

		<!--Car Expander Data Template-->
		<DataTemplate x:Key="carExpanderTemplate" DataType="model:CarViewModel">
			<Expander Header="{Binding .}" HeaderTemplate="{StaticResource carTemplate}" Template="{StaticResource rowExpanderTemplate}"
					  Padding="0" CornerRadius="0" MinHeight="0" HorizontalAlignment="Stretch" IsExpanded="{Binding IsDetailsExpanded}">
				<Grid RowDefinitions="Auto,*" DataContext="{Binding CarDetailsViewModel}">
					<Border Padding="5,4" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource CarDetailsSeperatorBackgroundBrush}" CornerRadius="0" Margin="0,1,0,0" IsVisible="{Binding IsCarMetadataVisible}">
						<Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="Auto,Auto,Auto">
							<!-- Row 1: Personal Info -->
							<StackPanel Orientation="Horizontal">
								<TextBlock Text="Name:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding Name}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>
							<StackPanel Orientation="Horizontal" Grid.Column="1" Margin="12,0,0,0">
								<TextBlock Text="Country/State:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding NationState}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>
							<StackPanel Orientation="Horizontal" Grid.Column="2" Margin="12,0,0,0">
								<TextBlock Text="Sponsor:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding Sponsor}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>

							<!-- Row 2: Car Specs -->
							<StackPanel Orientation="Horizontal" Grid.Row="1" Margin="0,2,0,0">
								<TextBlock Text="Make:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding Make}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>
							<StackPanel Orientation="Horizontal" Grid.Row="1" Grid.Column="1" Margin="12,2,0,0">
								<TextBlock Text="Color/Model:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding ModelEngine}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>
							<StackPanel Orientation="Horizontal" Grid.Row="1" Grid.Column="2" Margin="12,2,0,0">
								<TextBlock Text="Tires:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding Tires}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>

							<!-- Row 3: Team Info -->
							<StackPanel Orientation="Horizontal" Grid.Row="2" Grid.ColumnSpan="3" Margin="0,2,0,0">
								<TextBlock Text="Club:" Classes="sm" FontWeight="SemiBold" Foreground="{DynamicResource IconButtonForegroundBrush}"/>
								<TextBlock Text="{Binding Club}" Classes="sm" Margin="4,0,0,0"/>
							</StackPanel>
						</Grid>
					</Border>
					<Grid Grid.Row="1">
						<TextBlock Text="Loading..." Classes="sm" IsVisible="{Binding IsLoading}"/>
						<TabControl Padding="0" IsVisible="{Binding !IsLoading}">
							<!--Laps-->
							<TabItem IsSelected="{Binding IsTableTabSelected}">
								<TabItem.Header>
									<StackPanel Orientation="Horizontal" Spacing="4">
										<TextBlock Text="Laps" VerticalAlignment="Center"/>
										<PathIcon Height="10" Width="10" Foreground="{DynamicResource IconButtonForegroundBrush}" Data="{StaticResource tableIcon}" VerticalAlignment="Center"/>
									</StackPanel>
								</TabItem.Header>
								<Grid>
									<Grid RowDefinitions="Auto,*" Margin="10,3" IsVisible="{Binding LapList.Laps.Count}">
										<TextBlock Classes="tableheader" Text="LAP  POS  CLS POS     TIME        PIT     FLAG    RACE TIME    DRIVER"/>
										<ScrollViewer MaxHeight="250" Grid.Row="1">
											<ItemsControl ItemsSource="{Binding LapList.Laps}">
												<ItemsControl.ItemTemplate>
													<DataTemplate>
														<StackPanel Orientation="Horizontal">
															<TextBlock Text="{Binding LapNumber}" Classes="sm" Margin="1,0,0,0" Width="30"/>
															<StackPanel Orientation="Horizontal" Width="49">
																<TextBlock Text="{Binding OverallPosition}" Classes="sm"/>
																<PathIcon Height="10" Width="6" IsVisible="{Binding GainedOverallPosition}" Foreground="{DynamicResource PositionsGainedForegroundBrush}" Data="{StaticResource uparrowgeom}"/>
																<PathIcon Height="10" Width="6" IsVisible="{Binding LostOverallPosition}" Foreground="{DynamicResource PositionsLostForegroundBrush}" Data="{StaticResource downarrowgeom}"/>
															</StackPanel>
															<StackPanel Orientation="Horizontal" Width="42">
																<TextBlock Text="{Binding ClassPosition}" Classes="sm"/>
																<PathIcon Height="10" Width="6" IsVisible="{Binding GainedClassPosition}" Foreground="{DynamicResource PositionsGainedForegroundBrush}" Data="{StaticResource uparrowgeom}"/>
																<PathIcon Height="10" Width="6" IsVisible="{Binding LostClassPosition}" Foreground="{DynamicResource PositionsLostForegroundBrush}" Data="{StaticResource downarrowgeom}"/>
															</StackPanel>
															<TextBlock Text="{Binding LapTime}" Classes="sm" Width="61" Foreground="{Binding TimeColor}" FontWeight="{Binding TimeFontWeight}"/>
															<TextBlock Text="{Binding InPit}" Classes="sm" Width="21"/>
															<PathIcon Height="11" Width="70" Foreground="{Binding Flag, Converter={StaticResource FlagToColorConverter}}" Data="{StaticResource flaggeom}" ToolTip.Tip="{Binding FlagStr}"/>
															<TextBlock Text="{Binding RaceTime}" Classes="sm" Margin="1,0,0,0" Width="67"/>
															<TextBlock Text="{Binding DriverName}" Classes="sm" Margin="1,0,0,0"/>
														</StackPanel>
													</DataTemplate>
												</ItemsControl.ItemTemplate>
											</ItemsControl>
										</ScrollViewer>
									</Grid>
									<TextBlock Text="No laps found" Classes="sm" Margin="10,3" IsVisible="{Binding !LapList.Laps.Count}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</Grid>
							</TabItem>

							<!--Positions Chart-->
							<TabItem IsSelected="{Binding IsChartTabSelected}">
								<TabItem.Header>
									<StackPanel Orientation="Horizontal">
										<TextBlock Text="Positions" VerticalAlignment="Center"/>
										<StackPanel Orientation="Vertical" Margin="4,0,0,0">
											<PathIcon Height="8" Width="8" Foreground="{DynamicResource PositionsNeutralForegroundBrush}" Data="{StaticResource upArrow}"/>
											<PathIcon Height="8" Width="8" Foreground="{DynamicResource PositionsNeutralForegroundBrush}" Data="{StaticResource downArrow}" Margin="0,-2,0,0"/>
										</StackPanel>
									</StackPanel>
								</TabItem.Header>
								<Grid>
									<!--<lvc:CartesianChart MinWidth="90" Height="240" LegendPosition="Hidden"
									Series="{Binding Chart.Series}" YAxes="{Binding Chart.YAxes}" XAxes="{Binding Chart.XAxes}"
									ZoomMode="X" Padding="0"/>-->
									<ContentControl Content="{Binding Chart.Chart}" IsVisible="{Binding LapList.Laps.Count}"/>
									<TextBlock Text="No laps found" Classes="sm" Margin="10,3" IsVisible="{Binding !LapList.Laps.Count}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</Grid>
							</TabItem>

							<!--Penalties-->
							<TabItem IsSelected="{Binding IsPenaltiesTabSelected}" IsVisible="{Binding IsControlLogAvailable}">
								<TabItem.Header>
									<StackPanel Orientation="Horizontal">
										<TextBlock Text="Penalties" VerticalAlignment="Center"/>
										<PathIcon Height="10" Foreground="{DynamicResource IconButtonForegroundBrush}" Data="{StaticResource warningopengeom}" VerticalAlignment="Center"/>
									</StackPanel>
								</TabItem.Header>
								<Grid>
									<DataGrid ItemsSource="{Binding ControlLog}" IsReadOnly="True" Padding="0"
											  FontSize="10" ScrollViewer.HorizontalScrollBarVisibility="Auto" HorizontalAlignment="Stretch"
											  IsVisible="{Binding ControlLog.Count}">
										<DataGrid.Columns>
											<DataGridTextColumn Header="Time" Binding="{Binding Timestamp}" Width="70"/>
											<DataGridTextColumn Header="Corner" Binding="{Binding Corner}"/>
											<DataGridTextColumn Header="Car 1" Binding="{Binding Car1}"/>
											<DataGridTextColumn Header="Car 2" Binding="{Binding Car2}"/>
											<DataGridTextColumn Header="Note" Binding="{Binding Note}"/>
											<DataGridTextColumn Header="Status" Binding="{Binding Status}"/>
											<DataGridTextColumn Header="Penalty Action" Binding="{Binding PenaltyAction}"/>
											<DataGridTextColumn Header="Other Notes" Binding="{Binding OtherNotes}"/>
										</DataGrid.Columns>
									</DataGrid>
									<TextBlock Text="No control log entries found for this entry" Classes="sm" Margin="10,3" IsVisible="{Binding !ControlLog.Count}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</Grid>
							</TabItem>
						</TabControl>
					</Grid>
				</Grid>
			</Expander>
		</DataTemplate>

		<!--Class header expander-->
		<ControlTemplate x:Key="groupExpanderTemplate" TargetType="Expander">
			<DockPanel MinWidth="{TemplateBinding MinWidth}" MaxWidth="{TemplateBinding MaxWidth}">
				<ToggleButton x:Name="ExpanderHeader" Height="33" CornerRadius="{TemplateBinding CornerRadius}"
							  IsEnabled="{TemplateBinding IsEnabled}" Content="{TemplateBinding Header}" ContentTemplate="{TemplateBinding HeaderTemplate}"
							  IsChecked="{TemplateBinding IsExpanded, Mode=TwoWay}" Background="{DynamicResource ExpanderBackgroundBrush}" BorderBrush="{DynamicResource BorderPrimaryBrush}"/>
				<Border x:Name="ExpanderContent" IsVisible="{TemplateBinding IsExpanded, Mode=TwoWay}" Background="Transparent"
						BorderBrush="{TemplateBinding BorderBrush}"	BorderThickness="{TemplateBinding BorderThickness}"
						MinHeight="{TemplateBinding MinHeight}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Padding="{TemplateBinding Padding}">
					<ContentPresenter x:Name="PART_ContentPresenter" Content="{TemplateBinding Content}" ContentTemplate="{TemplateBinding ContentTemplate}"
									  Foreground="{TemplateBinding Foreground}" HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
									  VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
				</Border>
			</DockPanel>
		</ControlTemplate>

		<!-- DataGridSortIconMinWidth provided globally in App.axaml -->
	</UserControl.Resources>

	<UserControl.Styles>
		<Style Selector="TabItem">
			<Setter Property="FontSize" Value="13"/>
			<Setter Property="MinHeight" Value="28"/>
			<Setter Property="Height" Value="28"/>
			<Setter Property="Margin" Value="4,4,4,0"/>
			<Setter Property="Padding" Value="12,4"/>
			<Setter Property="CornerRadius" Value="4,4,0,0"/>
			<Setter Property="Background" Value="{DynamicResource EventRowBackgroundBrush}"/>
			<Setter Property="Foreground" Value="{DynamicResource TextMedForegroundBrush}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource BorderPrimaryBrush}"/>
			<Setter Property="BorderThickness" Value="1"/>
		</Style>

		<Style Selector="TabItem:pointerover /template/ Border#PART_LayoutRoot">
			<Setter Property="Background" Value="{DynamicResource EventRowHoverBackgroundBrush}"/>
			<Setter Property="Cursor" Value="Hand"/>
		</Style>

		<Style Selector="TabItem:selected">
			<Setter Property="Background" Value="{DynamicResource TimingTableBackgroundBrush}"/>
			<Setter Property="Foreground" Value="{DynamicResource TextLGForegroundBrush}"/>
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="BorderThickness" Value="1,1,1,0"/>
		</Style>

		<Style Selector="TabItem:selected /template/ Border#PART_LayoutRoot">
			<Setter Property="BorderBrush" Value="{DynamicResource BorderPrimaryBrush}"/>
			<Setter Property="BorderThickness" Value="1,1,1,0"/>
		</Style>

	</UserControl.Styles>

	<Grid>
		<Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto,Auto" Background="{Binding Flag, Converter={StaticResource FlagToColorConverter}}">
			<!--Top-->
			<Border Grid.Row="0" Background="{DynamicResource FlagOverlayBackgroundBrush}" Margin="4,5,4,0" CornerRadius="4" Padding="6,4">
				<Grid ColumnDefinitions="Auto,*,Auto,Auto">
					<StackPanel VerticalAlignment="Center">
						<Button Classes="back" Margin="0,0,5,0" Command="{Binding Back}" IsVisible="{Binding AllowEventList}"/>
						<Button Classes="icon" Command="{Binding ToggleLegend}" VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,2,5,0" Padding="0" ToolTip.Tip="Show legend">
							<PathIcon Height="11" Width="20" Foreground="{DynamicResource IconButtonForegroundBrush}" Data="{StaticResource infogeom}"/>
						</Button>
						<Button Classes="icon" Command="{Binding ToggleSearch}" VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,3,5,0" Padding="0" ToolTip.Tip="Search cars">
							<PathIcon Height="11" Width="20" Foreground="{DynamicResource IconButtonForegroundBrush}" Data="{StaticResource searchIcon}"/>
						</Button>
					</StackPanel>

					<StackPanel Grid.Column="1">
						<TextBlock Text="{Binding SessionName}" Classes="h1" FontWeight="Bold" TextTrimming="CharacterEllipsis"/>
						<TextBlock Text="{Binding TimeToGo, StringFormat='Time remaining: {0}'}" Classes="h1" IsVisible="{Binding ShowTimeToGo}"/>
						<TextBlock Text="{Binding RaceTime, StringFormat='Race Time: {0}'}" Classes="h1" IsVisible="{Binding ShowRaceTime}"/>
						<TextBlock Text="{Binding LocalTime, StringFormat='Local Time: {0}'}" Classes="h1"/>
						<TextBlock Text="{Binding TotalLaps, StringFormat='Laps: {0}'}" Classes="h1"/>
						<TextBlock Text="{Binding Flag, StringFormat='Flag: {0}'}" Classes="h1"/>
						<Grid ColumnDefinitions="Auto,*" IsVisible="{Binding IsBroadcastVisible}">
							<TextBlock Text="Watch Along: " Classes="h1"/>
							<Button Grid.Column="1" Classes="link" Command="{Binding LaunchBroadcast}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
								<TextBlock Text="{Binding BroadcastCompanyName}" FontSize="12" TextTrimming="CharacterEllipsis"/>
							</Button>
						</Grid>
					</StackPanel>

					<!--Test Buttons-->
					<!--<StackPanel Grid.Column="2">
					<Button Content="Dup VM" Command="{Binding InsertDuplicateCar}"/>
					<Button Content="Dup View" Command="{Binding InsertDuplicateView}"/>
					</StackPanel>-->

					<Image x:Name="OrganizationLogoImage" Source="{Binding OrganizationLogo}" Grid.Column="2" MaxHeight="45" MaxWidth="45" VerticalAlignment="Center" Margin="1,1,10,1"/>

					<StackPanel Grid.Column="3" Orientation="Vertical" VerticalAlignment="Center">
						<Button VerticalAlignment="Center" Command="{Binding ToggleSortMode}" Padding="3" Width="55">
							<StackPanel Orientation="Vertical">
								<TextBlock Text="Sorting" FontStyle="Italic" FontSize="11"/>
								<TextBlock Text="{Binding SortToggleText}" FontSize="9"/>
							</StackPanel>
						</Button>
						<Button VerticalAlignment="Center" Command="{Binding ToggleGroupMode}" Margin="0,8,0,0" Padding="3" Width="55">
							<StackPanel Orientation="Vertical">
								<TextBlock Text="Showing" FontStyle="Italic" FontSize="11"/>
								<TextBlock Text="{Binding GroupToggleText}" FontSize="9"/>
							</StackPanel>
						</Button>
					</StackPanel>
				</Grid>
			</Border>

			<!--Search Box-->
			<Border Grid.Row="1" Margin="4,3,4,0" Padding="4,1" IsVisible="{Binding IsSearchVisible}"
					Background="{DynamicResource TimingTableBackgroundBrush}" BorderThickness="1"
					BorderBrush="{DynamicResource BorderPrimaryBrush}" CornerRadius="4">
				<TextBox Watermark="Search by car # or name (comma separated)" Text="{Binding SearchText, Mode=TwoWay}"
						 FontSize="11" Padding="4,2" MinHeight="0" BorderThickness="0" Background="Transparent"/>
			</Border>

			<!--Table Header-->
			<Border x:Name="tableHeader" Grid.Row="2" Background="{DynamicResource TimingTableHeaderBackgroundBrush}" Margin="3,3,3,0" BorderThickness="1" BorderBrush="{DynamicResource BorderPrimaryBrush}">
				<Grid ColumnDefinitions="Auto,Auto,Auto,*" Margin="0,2,0,0">
					<TextBlock Text="" Grid.Column="0" Width="34"/>
					<TextBlock Text="LAST LAP             GAP             TO P1" Width="244" Grid.Column="1" Classes="tableheader"/>
					<StackPanel Orientation="Horizontal" Grid.Column="2" IsVisible="{Binding ShowPenaltyColumn}">
						<TextBlock Text="PENALTY" Classes="tableheader"/>
						<PathIcon Height="10" Margin="0,0,0,1" Foreground="{DynamicResource IconButtonForegroundBrush}" Data="{StaticResource warningopengeom}" VerticalAlignment="Center"/>
					</StackPanel>
					<TextBlock Text="BEST LAP" Grid.Column="3" HorizontalAlignment="Right" Classes="tableheader" Margin="0,0,7,0"/>
				</Grid>
			</Border>

			<TextBlock Text="Loading..." IsVisible="{Binding IsLoading}" Grid.Row="3" Classes="title" Margin="0,0,0,0" HorizontalAlignment="Center" VerticalAlignment="Center"/>

			<!--Car Table-->
			<Border x:Name="tableBody" Grid.Row="4" BorderThickness="1" BorderBrush="{DynamicResource BorderPrimaryBrush}" Margin="3,0,3,3" Background="{DynamicResource TimingTableBackgroundBrush}">
				<ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Hidden">
					<Grid>
						<!--Flat-->
						<ItemsControl ItemsSource="{Binding Cars}" ItemTemplate="{StaticResource carExpanderTemplate}" IsVisible="{Binding IsFlat}"/>

						<!--Grouped Classes-->
						<ItemsControl ItemsSource="{Binding GroupedCars}" IsVisible="{Binding !IsFlat}">
							<ItemsControl.ItemTemplate>
								<DataTemplate DataType="model:GroupHeaderViewModel">
									<Expander Header="{Binding .}" HorizontalAlignment="Stretch"
											  Padding="0" CornerRadius="0" MinHeight="0"
											  Template="{StaticResource groupExpanderTemplate}">
										<Expander.HeaderTemplate>
											<DataTemplate DataType="model:GroupHeaderViewModel">
												<Border Background="{Binding ClassColor}" CornerRadius="4" HorizontalAlignment="Left">
													<TextBlock Text="{Binding Name}" Classes="classgrp" Padding="8,5"/>
												</Border>
											</DataTemplate>
										</Expander.HeaderTemplate>
										<ItemsControl ItemsSource="{Binding .}" ItemTemplate="{StaticResource carExpanderTemplate}"/>
									</Expander>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>
					</Grid>
				</ScrollViewer>
			</Border>

			<!--Log Display-->
			<Border Grid.Row="6" BorderThickness="1" BorderBrush="{DynamicResource BorderPrimaryBrush}" Margin="3,0,3,3"
					Background="{DynamicResource TimingTableBackgroundBrush}"
					IsVisible="{Binding ShowLogDisplay}">
				<Grid RowDefinitions="Auto,*">
					<Grid ColumnDefinitions="*,Auto" Margin="5,3">
						<TextBlock Text="Application Logs" Classes="tableheader"/>
						<Button Grid.Column="1" Command="{Binding CopyLogsToClipboard}"
								Padding="5,2" FontSize="10" ToolTip.Tip="Copy logs to clipboard">
							<TextBlock Text="Copy" FontSize="10"/>
						</Button>
					</Grid>
					<ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="150">
						<TextBox Text="{Binding LogMessages}" IsReadOnly="True"
								 TextWrapping="Wrap" BorderThickness="0"
								 Background="Transparent" FontFamily="Consolas" FontSize="10"
								 AcceptsReturn="True" Padding="5"/>
					</ScrollViewer>
				</Grid>
			</Border>
		</Grid>

		<!--Legend Overlay-->
		<Grid IsVisible="{Binding IsLegendVisible}">
			<!--Dismiss area: clicking outside the legend closes it-->
			<Border Background="{DynamicResource LegendOverlayBackgroundBrush}" PointerPressed="LegendDismiss_PointerPressed"/>

			<!--Legend content centered at 80% width-->
			<Grid ColumnDefinitions="*,8*,*" VerticalAlignment="Center" IsHitTestVisible="False">
				<Border Grid.Column="1" Background="{DynamicResource TimingTableBackgroundBrush}"
						BorderBrush="{DynamicResource BorderPrimaryBrush}" BorderThickness="1"
						CornerRadius="8" Padding="12" IsHitTestVisible="True">
					<Grid RowDefinitions="Auto,*">
						<Grid ColumnDefinitions="*,Auto" MinHeight="30">
							<TextBlock Text="Legend" Classes="h1" FontWeight="Bold" VerticalAlignment="Center"/>
							<Button Grid.Column="1" Classes="icon" Command="{Binding ToggleLegend}" Padding="4,6" MinHeight="28" ToolTip.Tip="Close legend">
								<TextBlock Text="&#x2715;" FontSize="14"/>
							</Button>
						</Grid>
						<!--Legend content-->
						<Grid Grid.Row="1" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*" Margin="0,8,0,0">
							<!--Most positions gained overall-->
							<PathIcon Height="14" Width="14" Foreground="{DynamicResource LightningIconBrush}" Data="{StaticResource doubleLightning}" Margin="4,4"/>
							<TextBlock Grid.Column="1" Text="Most positions gained overall" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Most positions gained in class-->
							<PathIcon Grid.Row="1" Height="12" Width="12" Foreground="{DynamicResource LightningIconBrush}" Data="{StaticResource lightning}" Margin="4,4"/>
							<TextBlock Grid.Row="1" Grid.Column="1" Text="Most positions gained in class" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Fastest pace in-class-->
							<PathIcon Grid.Row="2" Height="20" Width="20" Foreground="{DynamicResource carRowLapTextForegroundOverallBestBrush}" Data="{StaticResource fastpace}" Margin="4,4"/>
							<TextBlock Grid.Row="2" Grid.Column="1" Text="Fastest pace in-class (average of last 5 contiguous laps)" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Warning from race control-->
							<PathIcon Grid.Row="3" Height="12" Width="12" Foreground="{DynamicResource LightningIconBrush}" Data="{StaticResource warningopengeom}" Margin="4,4"/>
							<TextBlock Grid.Row="3" Grid.Column="1" Text="Car was issued a warning by race control" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Car passed start/finish-->
							<Border Grid.Row="4" Width="24" Height="16" CornerRadius="3" Margin="4,4">
								<Border.Background>
									<SolidColorBrush Color="{DynamicResource carRowUpdatedBackgroundBrush}"/>
								</Border.Background>
							</Border>
							<TextBlock Grid.Row="4" Grid.Column="1" Text="Car passed the start/finish line" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Car has not updated recently-->
							<Border Grid.Row="5" Width="24" Height="16" CornerRadius="3" Margin="4,4">
								<Border.Background>
									<SolidColorBrush Color="{DynamicResource carRowStaleBackgroundBrush}"/>
								</Border.Background>
							</Border>
							<TextBlock Grid.Row="5" Grid.Column="1" Text="Car has not updated recently" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Best time posted last lap-->
							<TextBlock Grid.Row="6" Text="1:23.456" Classes="sm" Foreground="{DynamicResource carRowLapTextForegroundBestBrush}" FontWeight="Bold" VerticalAlignment="Center" Margin="4,4"/>
							<TextBlock Grid.Row="6" Grid.Column="1" Text="Best time posted last lap" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Fastest time overall or in-class-->
							<TextBlock Grid.Row="7" Text="1:23.456" Classes="sm" Foreground="{DynamicResource carRowLapTextForegroundOverallBestBrush}" FontWeight="Bold" VerticalAlignment="Center" Margin="4,4"/>
							<TextBlock Grid.Row="7" Grid.Column="1" Text="Fastest time overall or in-class (if grouped by class)" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--Sentinel live streaming-->
							<Image Grid.Row="8" Source="{Binding SentinelLegendImage}" Height="13" Margin="4,4"/>
							<TextBlock Grid.Row="8" Grid.Column="1" Text="In-car live streaming by Sentinel" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>

							<!--MyRaces.live streaming-->
							<Image Grid.Row="9" Source="{Binding MrlLegendImage}" Height="13" Margin="4,4"/>
							<TextBlock Grid.Row="9" Grid.Column="1" Text="In-car live streaming by MyRaces.live" Classes="sm" VerticalAlignment="Center" Margin="8,4" TextWrapping="Wrap"/>
						</Grid>
					</Grid>
				</Border>
			</Grid>
		</Grid>
	</Grid>
</UserControl>
